<!doctype html><html><head><title>MicroKernel Learning: SeL4</title><meta charset=utf-8><meta name=X-UA-Compatible content="IE=edge"><meta name=google-site-verification content><meta content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0" name=viewport><meta content="telephone=no" name=format-detection><meta name=description content><meta name=renderer content="webkit"><meta name=theme-color content="#ffffff"><link type=text/css rel=stylesheet href=/blog/vendor/css/bootstrap.min.css><link rel=stylesheet href=https://wangloo.github.io/blog/scss/journal.min.0f46f98b723f2aad4b02d9370bb6aa7848b5c2b2a5579642014082283683d2d8.css integrity="sha256-D0b5i3I/Kq1LAtk3C7aqeEi1wrKlV5ZCAUCCKDaD0tg=" media=screen><link rel=stylesheet href=https://wangloo.github.io/blog/scss/dark-mode.min.79c34391dbcff20df8b4dac718e2606701efcbfdb9f3b08447ac39ac9dc7b463.css integrity="sha256-ecNDkdvP8g34tNrHGOJgZwHvy/2587CER6w5rJ3HtGM=" media=screen><script src=/blog/vendor/js/loadCSS.js></script>
<script>loadCSS("https://fonts.googleapis.com/css?family=Fira+Mono|Material+Icons")</script><script src=/blog/js/toc.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script src=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js></script>
<script src=/blog/vendor/js/md5.min.js></script>
<script>var gitalk=new Gitalk({clientID:'12dfb0f809e5e6afde3d',clientSecret:'72aaf5660b3a7b43b0bffb4d683a605a7ea65dad',repo:'blogcomments_gitalk',owner:'wangloo',admin:['wangloo'],id:md5(location.pathname),distractionFreeMode:'false'});window.onload=function(){gitalk.render('gitalk-container')}</script></head><body><div id=app><div id=sideContainer class=side-container><a class="a-block nav-head false" href=https://wangloo.github.io/blog/><div class=nav-title>Soben's Secret Base</div><div class=nav-subtitle>Ëä±ÊúâÈáçÂºÄÊó•, ‰∫∫Êó†ÂÜçÂ∞ëÂπ¥</div></a><div class=nav-link-list><a class="a-block nav-link-item active" href=/blog/posts>Archive</a>
<a class="a-block nav-link-item false" href=/blog/tags>Tags</a>
<a class="a-block nav-link-item false" href=/blog/categories>Categories</a></div><div class=nav-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><div id=extraContainer class=extra-container><div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }"><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#sel4-capabilities onclick="onNavClick(`#sel4-capabilities-nav`)" id=sel4-capabilities-nav>seL4 Capabilities</a></li><ul><li><a href=#capability-derivation onclick="onNavClick(`#capability-derivation-nav`)" id=capability-derivation-nav>Capability Derivation</a></li><ul><li><a href=#mint-operation onclick="onNavClick(`#mint-operation-nav`)" id=mint-operation-nav>MINT OPERATION</a></li><li><a href=#copy-operation onclick="onNavClick(`#copy-operation-nav`)" id=copy-operation-nav>COPY OPERATION</a></li></ul></ul><li><a href=#sel4-kernel-objects onclick="onNavClick(`#sel4-kernel-objects-nav`)" id=sel4-kernel-objects-nav>seL4 Kernel Objects</a></li><li><a href=#sel4-system-calls onclick="onNavClick(`#sel4-system-calls-nav`)" id=sel4-system-calls-nav>seL4 System Calls</a></li><ul><li><a href=#different-object-support-different-operations onclick="onNavClick(`#different-object-support-different-operations-nav`)" id=different-object-support-different-operations-nav>Different object support different operations</a></li><ul><li><a href=#endpoints onclick="onNavClick(`#endpoints-nav`)" id=endpoints-nav>ENDPOINTS</a></li><li><a href=#notifications onclick="onNavClick(`#notifications-nav`)" id=notifications-nav>NOTIFICATIONS</a></li><li><a href=#other-objects onclick="onNavClick(`#other-objects-nav`)" id=other-objects-nav>OTHER OBJECTS</a></li></ul></ul><li><a href=#sel4-ipc onclick="onNavClick(`#sel4-ipc-nav`)" id=sel4-ipc-nav>seL4 IPC</a></li><li><a href=#sel4-threads onclick="onNavClick(`#sel4-threads-nav`)" id=sel4-threads-nav>seL4 Threads</a></li><ul><li><a href=#creating-a-thread onclick="onNavClick(`#creating-a-thread-nav`)" id=creating-a-thread-nav>Creating a thread</a></li><li><a href=#threads-and-stacks onclick="onNavClick(`#threads-and-stacks-nav`)" id=threads-and-stacks-nav>Threads and Stacks</a></li></ul></div></div><div class=pagination><a id=globalBackToTop class="pagination-action animated-visibility" href=#top :class="{ invisible: scrollY == 0 }"><i class="material-icons pagination-action-icon">keyboard_arrow_up</i></a>
<a type=button class=pagination-action id=darkModeToggleButton><span class="material-icons pagination-action-icon" id=darkModeToggleIcon>dark_mode</span></a></div></div><div class=single-column-drawer-container id=drawer v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }"><div class=drawer-content><div class=drawer-menu><a class="a-block drawer-menu-item active" href=/blog/posts>Archive</a>
<a class="a-block drawer-menu-item false" href=/blog/tags>Tags</a>
<a class="a-block drawer-menu-item false" href=/blog/categories>Categories</a><div class=toc><div class=toc-content><center>- CATALOG -</center><ul><ul><li><a href=#sel4-capabilities onclick="onNavClick(`#sel4-capabilities-nav`)" id=sel4-capabilities-nav>seL4 Capabilities</a></li><ul><li><a href=#capability-derivation onclick="onNavClick(`#capability-derivation-nav`)" id=capability-derivation-nav>Capability Derivation</a></li><ul><li><a href=#mint-operation onclick="onNavClick(`#mint-operation-nav`)" id=mint-operation-nav>MINT OPERATION</a></li><li><a href=#copy-operation onclick="onNavClick(`#copy-operation-nav`)" id=copy-operation-nav>COPY OPERATION</a></li></ul></ul><li><a href=#sel4-kernel-objects onclick="onNavClick(`#sel4-kernel-objects-nav`)" id=sel4-kernel-objects-nav>seL4 Kernel Objects</a></li><li><a href=#sel4-system-calls onclick="onNavClick(`#sel4-system-calls-nav`)" id=sel4-system-calls-nav>seL4 System Calls</a></li><ul><li><a href=#different-object-support-different-operations onclick="onNavClick(`#different-object-support-different-operations-nav`)" id=different-object-support-different-operations-nav>Different object support different operations</a></li><ul><li><a href=#endpoints onclick="onNavClick(`#endpoints-nav`)" id=endpoints-nav>ENDPOINTS</a></li><li><a href=#notifications onclick="onNavClick(`#notifications-nav`)" id=notifications-nav>NOTIFICATIONS</a></li><li><a href=#other-objects onclick="onNavClick(`#other-objects-nav`)" id=other-objects-nav>OTHER OBJECTS</a></li></ul></ul><li><a href=#sel4-ipc onclick="onNavClick(`#sel4-ipc-nav`)" id=sel4-ipc-nav>seL4 IPC</a></li><li><a href=#sel4-threads onclick="onNavClick(`#sel4-threads-nav`)" id=sel4-threads-nav>seL4 Threads</a></li><ul><li><a href=#creating-a-thread onclick="onNavClick(`#creating-a-thread-nav`)" id=creating-a-thread-nav>Creating a thread</a></li><li><a href=#threads-and-stacks onclick="onNavClick(`#threads-and-stacks-nav`)" id=threads-and-stacks-nav>Threads and Stacks</a></li></ul></div></div></div></div></div><transition name=fade><div id=drawer-mask v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if=isDrawerOpen v-on:click=toggleDrawer></div></transition><nav id=navBar class="navbar sticky-top navbar-light single-column-nav-container"><div id=navBackground class=nav-background></div><div class="container container-narrow nav-content"><button id=nav_dropdown_btn class=nav-dropdown-toggle type=button v-on:click=toggleDrawer>
<i class=material-icons>menu</i></button>
<a id=navTitle class=navbar-brand href=https://wangloo.github.io/blog/>Soben's Secret Base</a>
<button type=button class=nav-darkmode-toggle id=darkModeToggleButton2>
<i class=material-icons id=darkModeToggleIcon2>dark_mode</i></button></div></nav><div class=single-column-header-container id=pageHead v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }"><a href=https://wangloo.github.io/blog/><div class=single-column-header-title>Soben's Secret Base</div><div class=single-column-header-subtitle>Ëä±ÊúâÈáçÂºÄÊó•, ‰∫∫Êó†ÂÜçÂ∞ëÂπ¥</div></a></div><div id=content><div id=streamContainer class=stream-container><div class="post-list-container post-list-container-shadow"><div class=post><div class=post-head-wrapper-text-only><div class=post-title>MicroKernel Learning: SeL4<div class=post-meta><time itemprop=datePublished>2022-06-04 11:52</time>
<i class=material-icons>schedule</i>
2 min
45 s.</div></div></div><div class=post-body-wrapper><div class=post-body v-pre><h2 id=sel4-capabilities>seL4 Capabilities</h2><p>In seL4, capabilities are stored in <strong>C-space</strong>. C-space is a hierarchical data structure very similar to <strong>page table</strong>.</p><ul><li>page table is a mapping from virtual address to physical address.</li><li>C-space is a mapping from <strong>object ID</strong> to <strong>capability</strong>.</li><li>Kernel object is made up of several <strong>C-nodes</strong>, just like a page table made up of individual page tables.</li><li>Each C-nodes is an array of cap <em>slots</em>, which contain capability.</li></ul><p>Inaccessible to userland, you can never hold an <strong>actual capability</strong></p><ul><li>You can only hold a reference to capability, which pointers into C-space(slot addresses)</li><li>These C-space addresses are called <strong>CPTRs</strong></li></ul><blockquote><p>You don&rsquo;t need to do the transform, because this is typically extracted in some libs.</p></blockquote><p>Capabilities convey specific privilege (acces rights)</p><ul><li>Read, Write, Execute, GrantReply(<code>call</code>), Grant(<code>cap transfer</code>)</li></ul><p>Main operations on capabilities:</p><ul><li><code>Invoke</code>perform operation on object referred to by cap.<ul><li>For example, map some frame into memory. You need to have capabilities to both the frame and address space.</li></ul></li><li><code>Copy</code>|<code>Mint</code>|<code>Grant</code>: create copy of cap with <strong>same/lesser</strong> privilege.</li><li><code>Move</code>|<code>Mutate</code>: transfer to different address with <strong>same/lesser</strong> privilege.<ul><li>Between C-space or within C-space.</li></ul></li><li><code>Delete</code>: invalidate slot(cleans up object if this is the only cap to it)</li><li><code>Revoke</code>: delete any derived(eg. copied or minted) caps</li></ul><h3 id=capability-derivation>Capability Derivation</h3><h4 id=mint-operation>MINT OPERATION</h4><p>The <strong>Mint</strong> operation creates a new, less powerful cap</p><ul><li>Can add badge</li><li>Can strip access rights, eg <code>RW->RO</code></li></ul><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#111>mint</span><span style=color:#111>(</span><span style=color:#111>dest</span><span style=color:#111>,</span> <span style=color:#111>src</span><span style=color:#111>,</span> <span style=color:#111>rights</span><span style=color:#111>,</span> <span style=color:#111>badge</span><span style=color:#111>)</span>
</span></span></code></pre></div><ul><li>The first two arguement are <strong>capability pointers(CPTR)</strong> to a C-space(represented by C-node), which are references inside C-node.</li><li>The <strong>destination C-node cap</strong> must allow modification</li><li>Then you have the rights and the <em>batch</em> of the new cap.</li></ul><p>üìå This is an alternative of sending addressed capabilities by <strong>IPC operation</strong>.
That is what operating system do to set up protection domains for <strong>user level process</strong>.</p><h4 id=copy-operation>COPY OPERATION</h4><blockquote><p>Copy as a version of <em>Mint</em>.</p></blockquote><p>¬†</p><h2 id=sel4-kernel-objects>seL4 Kernel Objects</h2><p>In file <code>libsel4\include\sel4\objecttype.h</code></p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#00a8c8>typedef</span> <span style=color:#00a8c8>enum</span> <span style=color:#111>api_object</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>seL4_UntypedObject</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>seL4_TCBObject</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>seL4_EndpointObject</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>seL4_NotificationObject</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>seL4_CapTableObject</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#ifdef CONFIG_KERNEL_MCS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>seL4_SchedContextObject</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span>    <span style=color:#111>seL4_ReplyObject</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#111>seL4_NonArchObjectTypeCount</span><span style=color:#111>,</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span> <span style=color:#111>seL4_ObjectType</span><span style=color:#111>;</span>
</span></span></code></pre></div><p>¬†</p><h2 id=sel4-system-calls>seL4 System Calls</h2><p>seL4 has <code>11</code> syscalls:</p><p><code>Yield()</code>: invokes scheduler</p><ul><li>does NOT require a capability!</li></ul><p><code>Send()</code>,<code>Recv()</code> and variants/combinations thereof: IPC operations</p><ul><li><code>Call()</code>,<code>ReplyRecv()</code>: usually invokes by client/server</li><li><code>Send()</code>, <code>NBSend()</code>: send-only and non-blocking version of it.</li><li><code>Recv()</code>, <code>NBRecv()</code>, <code>NBSendRecv()</code></li><li><code>Wait()</code>, <code>NBWait()</code>, <code>NBSendWait()</code></li></ul><blockquote><p>We just use <code>Call()</code> normally, the others are only for bootstrapping protocols and exception handling.</p></blockquote><p>Call() is atomic Send() + reply-object setup + Wait()</p><ul><li>cannot be simulated with one-way operations!</li></ul><p>ReplyRecv() is NBSend() + Recv()</p><h3 id=different-object-support-different-operations>Different object support different operations</h3><h4 id=endpoints>ENDPOINTS</h4><p>Endpoints support all 10 IPC variants.</p><h4 id=notifications>NOTIFICATIONS</h4><p>Notifications support:</p><ul><li>NBSend() - aliased as Signal()</li><li>Wait()</li><li>NBWait() - aliased as Poll()</li></ul><h4 id=other-objects>OTHER OBJECTS</h4><p>Other objects only supports <code>Call()</code> operation.</p><ul><li>Appear as (kernel-implemented) servers. If you invoking a method on an object, this is done by treating the object as a kernel-implemented server. And you invoke it with a <code>call()</code> operation just as you do a normal server invocation.</li><li>Each of these kernel objects has a different kernel-defined protocol<ul><li>operations encoded in message tag</li><li>parameters passed in message words</li></ul></li><li>Mostly hidden behind <strong>syscall</strong> wrappers, user do not need to know this details.</li></ul><p>¬†</p><h2 id=sel4-ipc>seL4 IPC</h2><blockquote><p>IPC in seL4 is a way to realize <strong>cross-domain</strong> invocation.</p></blockquote><p>seL4 IPC is not a mechanism for shipping data. Transfering data is axillary but not the primary purpose.</p><p>seL4 IPC is a protected procedure call, a user-controlled context switch(from clients context into server context).</p><p>¬†</p><h2 id=sel4-threads>seL4 Threads</h2><h3 id=creating-a-thread>Creating a thread</h3><ol><li>Obtain a TCB object</li><li>Set attributes: V-space, C-space, fault endpoint, IPC buffer</li><li>Set Scheduling parameters:<ul><li>priority, scheduling context, timeout endpoint(maybe MCP)</li></ul></li><li>Set architecture-related registers</li></ol><h3 id=threads-and-stacks>Threads and Stacks</h3><p>Stacks are completely user-managed, kernel doesn&rsquo;t care!</p><blockquote><p>Kernel only preserves SP.. on context switch</p></blockquote><p>Stack location, allocation, size must be managed by <strong>userland</strong>.</p><p>Kernel beware of stack overflow</p><hr width=100% id=EOF><p style=color:#777>Last modified on 2022-06-12</p></div></div><nav class=post-pagination><a class=newer-posts>Next<br>No newer posts.</a>
<a class=older-posts href=https://wangloo.github.io/blog/posts/hugo/>Previous<br>HuGo Configuration</a></nav><div class=post-comment-wrapper><div id=gitalk-container></div></div></div></div></div></div><div id=single-column-footer>Hugo Theme <a href=https://github.com/amazingrise/hugo-theme-diary>Diary</a> by <a href=https://risehere.net/>Rise</a><br>Ported from <a href=https://mak1t0.cc/ target=_blank rel="noreferrer noopener">Makito</a>'s <a href=https://github.com/SumiMakito/hexo-theme-journal/ target=_blank rel="noreferrer noopener">Journal.</a><br><br>&copy;
@2019 Notepadium.</div></div><script src=/blog/js/journal.js></script></body></html>